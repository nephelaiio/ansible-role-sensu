---
- name: create sensu directories
  file:
    state: directory
    path: "{{ item }}"
    owner: "{{ sensu_user_name }}"
    group: "{{ sensu_user_group }}"
    mode: 0755
  with_items:
    - "{{ sensu_user_home }}/bin"
    - "{{ sensu_pid_dir }}"
    - "{{ sensu_log_dir }}"
    - "{{ sensu_conf_root }}"
    - "{{ sensu_conf_dir }}"
  become: yes

- name: create install bin helper
  template:
    src: sensu-install.j2
    dest: "{{ sensu_user_home }}/bin/sensu-install"
    owner: "{{ sensu_user_name }}"
    group: "{{ sensu_user_group }}"
    mode: 0755
  become: yes

- name: create server bin helper
  template:
    src: sensu-service.j2
    dest: "{{ sensu_user_home }}/bin/sensu-service"
    owner: "{{ sensu_user_name }}"
    group: "{{ sensu_user_group }}"
    mode: 0755
  become: yes

- name: create systemd service units
  template:
    src: systemd.service.j2
    dest: "/etc/systemd/system/sensu-{{ service }}.service"
  vars:
    service: "{{ item }}"
  with_items:
    - client
    - server
    - api
  become: yes
  notify: reload systemd

- name: manage common configuration
  template:
    src: conf.json.j2
    dest: "{{ sensu_conf_dir }}/common.json"
    owner: "{{ sensu_user_name }}"
    group: "{{ sensu_user_group }}"
  vars:
    sensu_conf: "{{ sensu_conf_common }}"
  become: yes
  notify:
    - restart client service
    - restart master service

- name: manage client configuration
  template:
    src: conf.json.j2
    dest: "{{ sensu_conf_dir }}/client.json"
    owner: "{{ sensu_user_name }}"
    group: "{{ sensu_user_group }}"
  vars:
    sensu_conf: "{{ sensu_conf_client }}"
  become: yes
  notify: restart client service
  when: not sensu_server

- name: manage server configuration
  template:
    src: conf.json.j2
    dest: "{{ sensu_conf_dir }}/server.json"
    owner: "{{ sensu_user_name }}"
    group: "{{ sensu_user_group }}"
  vars:
    sensu_conf: "{{ sensu_conf_server }}"
  become: yes
  notify: restart master service
  when: sensu_server

- name: manage systemd tmpfiles
  template:
    src: systemd-tmpfiles.conf.j2
    dest: /usr/lib/tmpfiles.d/sensu.conf
  vars:
    pid_dir: "{{ sensu_pid_dir }}"
    user_name: "{{ sensu_user_name }}"
    user_group: "{{ sensu_user_group }}"
  become: yes

- name: manage client service
  systemd:
    name: sensu-client
    state: "{{ sensu_service_state }}"
    enabled: "{{ sensu_service_enabled }}"
  become: yes

- name: manage master service
  systemd:
    name: "{{ item }}"
    state: "{{ sensu_service_state }}"
    enabled: "{{ sensu_service_enabled }}"
  with_items:
    - sensu-api
    - sensu-server
  become: yes
  when: sensu_server
